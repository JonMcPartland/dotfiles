#!/usr/bin/env bash

function prettify {
  local PRMPT=""
  local BLACK
  local RED
  local GREEN
  local YELLOW
  local BLUE
  local MAGENTA
  local CYAN
  local WHITE
  local BOLD
  local DIM
  local RESET
  local BREAK

  # set scheme vars
  BLACK=$(tput setaf 0)
  RED=$(tput setaf 1)
  GREEN=$(tput setaf 2)
  YELLOW=$(tput setaf 3)
  BLUE=$(tput setaf 4)
  MAGENTA=$(tput setaf 5)
  CYAN=$(tput setaf 6)
  WHITE=$(tput setaf 7)
  BOLD=$(tput bold)
  DIM=$(tput dim)
  RESET=$(tput sgr0)
  BREAK="\n"

  # timestamp
  PRMPT+="\[$RESET\]"
  PRMPT+="\[$BOLD$WHITE\][\[$WHITE\]$(date +"%H:%M:%S")\[$BOLD$WHITE\]]"

  # user name
  PRMPT+="\[$RESET\]"
  PRMPT+="\[$MAGENTA\] \u "

  # pwd prefix
  PRMPT+="\[$RESET\]"
  PRMPT+="\[$WHITE\]in "

  # pwd
  PRMPT+="\[$RESET\]"
  PRMPT+="\[$BLUE\]"
  if [[ ${PWD##*/} == "" ]]; then
    PRMPT+="/"
  elif [[ ${PWD##*/} == $(whoami) ]]; then
    PRMPT+="~"
  else
    PRMPT+="${PWD##*/}"
  fi

  # git info
  read -r ISGIT GITBRANCH GITSTATUS <<< $(isInGit 2> /dev/null)
  read -r SVNSTATUS SVNBRANCH SVNREV <<< $(isInSvn 2> /dev/null)
  if [[ $ISGIT ]]; then          # if is git repo
    if [[ $GITSTATUS == "" ]]; then # if clean repo
      CLR=$GREEN                 # green status
    else                         # else if dirty repo
      CLR=$RED                   # red status
    fi

    # prefix
    PRMPT+="\[$RESET\]"
    PRMPT+="\[$WHITE\] on "

    # set GITBRANCH name
    PRMPT+="\[$RESET\]"
    PRMPT+="\[$DIM$CLR\]$GITBRANCH"
  elif [[ $SVNBRANCH ]]; then
    if [[ $SVNSTATUS -gt 0 ]]; then
      CLR=$RED
    else
      CLR=$GREEN
    fi

    PRMPT+="\[$RESET\]"
    PRMPT+="\[$BLACK\] on "

    PRMPT+="\[$RESET\]"
    PRMPT+="\[$DIM$CLR\]$SVNBRANCH"

    PRMPT+="\[$RESET\]"
    PRMPT+="\[$BLACK\] at "

    PRMPT+="\[$RESET\]"
    PRMPT+="\[$DIM$CLR\]$SVNREV"
  fi

  # the prompt itself
  PRMPT+="\[$RESET\]"
  PRMPT+="$BREAK\[$YELLOW\]Â» "
  PRMPT+="\[$RESET\]"

  # old fg colour: a4e192
  # smso makes it bg colour
  # PRMPT+="\[$(tput smso)\]"

  # set PS1
  export PS1=$PRMPT
}

PROMPT_COMMAND=prettify
