#!/usr/bin/env bash

prettify() {
  local PRMPT=""

  # set scheme vars
  local BLACK=$(tput setaf 0)
  local RED=$(tput setaf 1)
  local GREEN=$(tput setaf 2)
  local YELLOW=$(tput setaf 3)
  local BLUE=$(tput setaf 4)
  local MAGENTA=$(tput setaf 5)
  local CYAN=$(tput setaf 6)
  local WHITE=$(tput setaf 7)
  local BOLD=$(tput bold)
  local DIM=$(tput dim)
  local RESET=$(tput sgr0)
  local BREAK="\n"

  # timestamp
  PRMPT+="\[$RESET\]"
  PRMPT+="\[$BOLD$WHITE\][\[$BLACK\]$(date +"%H:%M")\[$BOLD$WHITE\]]"

  # user name
  PRMPT+="\[$RESET\]"
  PRMPT+="\[$MAGENTA\] \u "

  # pwd prefix
  PRMPT+="\[$RESET\]"
  PRMPT+="\[$WHITE\]in "

  # pwd
  PRMPT+="\[$RESET\]"
  PRMPT+="\[$BLUE\]"
  if [[ ${PWD##*/} == "" ]]; then
    PRMPT+="/"
  elif [[ ${PWD##*/} == $(whoami) ]]; then
    PRMPT+="~"
  else
    PRMPT+="${PWD##*/}"
  fi

  # git info
  read ISGIT GITBRANCH GITSTATUS <<< $(isInGit 2> /dev/null)
  read SVNSTATUS SVNBRANCH SVNREV <<< $(isInSvn 2> /dev/null)
  if [[ $ISGIT ]]; then          # if is git repo
    if [[ $GITSTATUS == "" ]]; then # if clean repo
      CLR=$GREEN                 # green status
    else                         # else if dirty repo
      CLR=$RED                   # red status
    fi

    # prefix
    PRMPT+="\[$RESET\]"
    PRMPT+="\[$WHITE\] on "

    # set GITBRANCH name
    PRMPT+="\[$RESET\]"
    PRMPT+="\[$DIM$CLR\]$GITBRANCH"
  elif [[ $SVNBRANCH ]]; then
    if [[ $SVNSTATUS -gt 0 ]]; then
      CLR=$RED
    else
      CLR=$GREEN
    fi

    PRMPT+="\[$RESET\]"
    PRMPT+="\[$WHITE\] on "

    PRMPT+="\[$RESET\]"
    PRMPT+="\[$DIM$CLR\]$SVNBRANCH"

    PRMPT+="\[$RESET\]"
    PRMPT+="\[$WHITE\] at "

    PRMPT+="\[$RESET\]"
    PRMPT+="\[$DIM$CLR\]$SVNREV"
  fi

  # the prompt itself
  PRMPT+="\[$RESET\]"
  PRMPT+="$BREAK\[$YELLOW\]Â» "
  PRMPT+="\[$RESET\]"

  # old fg colour: a4e192
  # smso makes it bg colour
  # PRMPT+="\[$(tput smso)\]"

  # set PS1
  export PS1=$PRMPT
}


PROMPT_COMMAND=prettify
